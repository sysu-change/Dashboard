var flow2svg={init:function(){var k=this;var b=$("#svg_exporter");this.cleanSvgHtml();var r=this.calcCanvasSize();var p=SVG("svg_exporter").size(r.w,r.h);var a=Model.define.elements;var l=Model.define.theme==null?false:true;var n=Model.define.page;if(n.backgroundColor!=null&&n.backgroundColor!="transparent"){p.rect(r.w,r.h).fill("rgb("+n.backgroundColor+")")}var o=[];for(var q in a){o.push(Utils.copy(a[q]))}o=o.sort(function(j,i){return j.props.zindex-i.props.zindex});for(var g=0,h=o.length;g<h;g++){var m=o[g];if(m.name=="linker"){this.linker2svg(m,p,r,l)}else{if(m.parent==""||m.parent==null){this.shape2svg(m,p,r);if(m.children!=null&&m.children.length>0){var d=m.children;for(var f=0;f<d.length;f++){var e=d[f];var c=Utils.copy(a[e]);this.shape2svg(c,p,r,l)}}}}}return{w:r.w,h:r.h}},getSvgHtml:function(){this.init();var a=$("#svg_exporter").html();return a},cleanSvgHtml:function(){$("#svg_exporter").html("")},shape2svg:function(shape,draw,canvasSize,hasTheme){var props=shape.props,x=25,y=25,w=props.w,h=props.h,path=shape.path,textBlock=shape.textBlock;props.x-=canvasSize.minX;props.y-=canvasSize.minY;if(props.x<canvasSize.w&&props.x+props.w<canvasSize.w){x=props.x-15}if(props.y<canvasSize.h&&props.y+props.h<canvasSize.h){y=props.y-15}var fStyle=Utils.getShapeFillStyle(shape.fillStyle,hasTheme);var lStyle=Utils.getShapeLineStyle(shape.lineStyle,hasTheme);var shapeBox=Utils.getShapeBox(shape);var shapeStyle=shape.shapeStyle;var defs=draw.defs();var group=draw.group().attr("transform","translate("+x+","+y+")");renderShape(path,group,fStyle,lStyle,defs);renderShapeMarkers(group);renderText(textBlock,group);function renderShapeMarkers(group){if(shape.attribute&&shape.attribute.markers&&shape.attribute.markers.length>0){var markers=shape.attribute.markers;var size=Schema.config.markerSize;var spacing=4;var offset=shape.attribute.markerOffset;var markersWidth=markers.length*size+(markers.length-1)*spacing;var x=shape.props.w/2-markersWidth/2;for(var i=0;i<markers.length;i++){var markerName=markers[i];var top=shape.props.h-size-offset;var marker_g=group.group().attr("transform","translate("+x+","+top+")");var markerPaths=Schema.markers[markerName].call(shape,size);renderShape(markerPaths,marker_g,fStyle,lStyle,defs);x+=size+spacing}}}function renderShape(path,group,fStyle,lStyle,defs){for(var i=0;i<path.length;i++){var cmd=path[i];var lineStyle=$.extend({},lStyle,cmd.lineStyle);var fillStyle=$.extend({},fStyle,cmd.fillStyle);var actions=cmd.actions,pathStr="";for(var j=0;j<actions.length;j++){var action=actions[j];pathStr+=parsePath(action,w,h,lineStyle.lineWidth)}if(fillStyle.type!="image"){var group_path=group.path(pathStr);renderBorder(lineStyle,fillStyle,group_path)}renderFill(fillStyle,group_path,defs)}if(props.angle!=null&&props.angle!=0){var angle=180*props.angle/Math.PI;group.rotate(angle,props.w/2,props.h/2)}}function renderFill(fillStyle,group_path,defs){if(fillStyle.type=="none"){if(group_path!=null){group_path.fill("none")}return}else{if(fillStyle.type=="image"){var image=fillStyle.fileId;if(image.indexOf("http")<0){if(image.indexOf("/")<0){image="/file/id/"+image+"/diagram_user_image"}else{image="https://www.processon.com/"+image}}else{if(image.indexOf("orgu2a928.bkt.clouddn.com")>=0){image=image.replace("orgu2a928.bkt.clouddn.com","cdn2.processon.com")}else{if(image.indexOf("7xt9nt.com1.z0.glb.clouddn.com")>=0){image=image.replace("7xt9nt.com1.z0.glb.clouddn.com","cdn.processon.com")}else{if(image.indexOf("p7o7ul1nf.bkt.clouddn.com")>=0){image=image.replace("p7o7ul1nf.bkt.clouddn.com","cdn1.processon.com")}}}}var imgW=fillStyle.imageW,imgH=fillStyle.imageH;if(fillStyle.display=="stretch"){imgW=props.w;imgH=props.h}group.image(image).size(imgW,imgH).attr("preserveAspectRatio","none");return}}if(fillStyle.type=="gradient"&&fillStyle.gradientType=="radial"){var gradient=defs.gradient("radial",function(stop){stop.at(0,"rgb("+fillStyle.beginColor+")",fillStyle.alpha);stop.at(1,"rgb("+fillStyle.endColor+")",fillStyle.alpha)});gradient.radius(fillStyle.radius);group_path.fill(gradient)}else{if(fillStyle.type=="gradient"&&fillStyle.gradientType=="linear"){var gradient=defs.gradient("linear",function(stop){stop.at(0,"rgb("+fillStyle.beginColor+")",fillStyle.alpha);stop.at(1,"rgb("+fillStyle.endColor+")",fillStyle.alpha)});gradient.from(0,0).to(0,1);group_path.fill(gradient)}else{var st=$.extend(fillStyle,shape.fillStyle);var fillStyle_=Utils.getShapeFillStyle(st,hasTheme);var color=fillStyle_.color;if(color.indexOf("r")>=0){var colors=[];if($.isEmptyObject(shape.fillStyle)){colors=fillStyle_.color.split(",")}else{colors=shape.fillStyle.color.split(",")}var r=colors[0];var g=colors[1];var b=colors[2];if(typeof r=="string"){color=color.replace("r",255).replace("g",255).replace("b",255)}else{color=color.replace("r",r).replace("g",g).replace("b",b)}var cs=color.split(",");var newColor=[];newColor.push(eval(cs[0]));newColor.push(eval(cs[1]));newColor.push(eval(cs[2]));color=newColor.join(",")}var fs={color:"rgb("+color+")"};if(fillStyle.alpha!=null){fs.opacity=fillStyle.alpha}group_path.fill(fs)}}}function renderBorder(lineStyle,fillStyle,group_path){var lineStyle_=Utils.getShapeLineStyle(shape.lineStyle,false);var lineWidth=lineStyle.lineWidth;if(typeof lineStyle.lineWidth=="string"){lineWidth=eval("var lineWidth="+lineStyle_.lineWidth+";"+lineStyle.lineWidth)}var style={width:lineWidth,color:"rgb("+lineStyle.lineColor+")"};if(lineStyle.lineStyle=="dot"){style=$.extend(style,{dasharray:"3,4"})}else{if(lineStyle.lineStyle=="dashed"){style=$.extend(style,{dasharray:"10,6"})}else{if(lineStyle.lineStyle=="dashdot"){style=$.extend(style,{dasharray:"10,6,3,6"})}}}if(lineStyle.lineWidth==0){group_path.stroke("none")}else{group_path.stroke(style)}}function renderText(textBlock,group){for(var i=0;i<textBlock.length;i++){var textObj=textBlock[i];var pos=textObj.position,text=textObj.text,style=null;console.log(text);var fontStyle=Utils.getShapeFontStyle(shape.fontStyle);fontStyle=$.extend({},fontStyle,textObj.fontStyle);var _w=eval("var w="+props.w+";var h = "+props.h+";"+pos.w);var _h=eval("var w="+props.w+";var h = "+props.h+";"+pos.h);var _x=eval("var w="+props.w+";var h = "+props.h+";"+pos.x);var _y=eval("var w="+props.w+";var h = "+props.h+";"+pos.y);if(fontStyle.orientation=="horizontal"){var blockCenter={x:_x+_w/2,y:_y+_h/2};pos={x:blockCenter.x-_h/2,y:blockCenter.y-_w/2,w:_h,h:_w}}var _group=group.group();var fobj=_group.foreignObject(_w,_h);fobj.attr("x",_x);fobj.attr("style","overflow:visible;");var style="font-family:"+fontStyle.fontFamily+";text-align:"+fontStyle.textAlign+";font-size:"+fontStyle.size+"px;vertical-align:"+fontStyle.vAlign+";color:rgb("+fontStyle.color+");";if(fontStyle.bold){style+="font-weight:700;"}else{style+="font-weight:400;"}if(fontStyle.italic){style+="font-style:italic;"}if(fontStyle.underline){style+="text-decoration:underline;"}style+="line-height:"+Math.round(fontStyle.size*1.25)+"px;width:"+_w+"px;word-break:break-word;border:0;";var tempDiv=$("<div contenteditable=true style='"+style+";display:inline-block;'></div>").appendTo("body");var text1=(text||"").replace(/<br>/g,"<div></div>").replace(/\n/g,"<div></div>").replace(/\t/g,"&nbsp;").replace(/\  /g,"&nbsp;&nbsp;");if(typeof isNewTextV!="undefined"&&!isNewTextV){text1=text1.replace(/</g,"&lt;").replace(/>/g,"&gt;");text1=text1.replace(/&lt;br&gt;/gi,"<br>");text1=text1.replace(/&lt;b&gt;/gi,"<b>").replace(/&lt;\/b&gt;/gi,"</b>");text1=text1.replace(/&lt;div&gt;/gi,"<div>").replace(/&lt;\/div&gt;/gi,"</div>");text1=text1.replace(/&lt;i&gt;/gi,"<i>").replace(/&lt;\/i&gt;/gi,"</i>");text1=text1.replace(/&lt;u&gt;/gi,"<u>").replace(/&lt;\/u&gt;/gi,"</u>");text1=text1.replace(/&lt;font/gi,"<font").replace(/\"&gt;/gi,'">').replace(/&lt;\/font&gt;/gi,"</font>");text1=text1.replace(/&lt;span/gi,"<span").replace(/&lt;\/span&gt;/gi,"</span>");text1=text1.replace(/&lt;p/gi,"<p").replace(/&lt;\/p&gt;/gi,"</p>")}tempDiv.html(text1);var textH=tempDiv.outerHeight();fobj.attr("height",textH);var top=0;if(fontStyle.vAlign=="middle"){top=(_h/2-textH/2)}else{if(fontStyle.vAlign=="bottom"){top=(_h-textH)}else{top=0}}fobj.attr("y",top+_y);tempDiv.remove();if(fontStyle.orientation=="horizontal"){var textCenter={x:_x+_w/2,y:top+textH/2};var textAngle=shape.props.angle;if(textAngle!=0){var center={x:shape.props.w/2,y:shape.props.h/2};textCenter=Utils.getRotated(center,textCenter,textAngle)}textAngle=(Math.PI*1.5+textAngle)%(Math.PI*2);var deg=Math.round(textAngle/(Math.PI*2)*360);var left=(textCenter.x+(shape.props.x-shapeBox.x))-pos.w/2;var degStr="transform:rotate("+deg+"deg);width:"+pos.w+"px;height:"+textH+"px;margin-left:"+left+"px;";style+=degStr}else{style+=""}fobj.appendChild("div",{innerHTML:text1,style:style})}}function parsePath(action,w,h,lineWidth){var path="";if(action.action=="close"){return"Z"}var ac=action.action.substring(0,1).toUpperCase();path+=ac+" ";var baseStr="var w = "+w+";var h = "+h+";";if(action.action=="curve"){return path+eval(baseStr+action.x1)+" "+eval(baseStr+action.y1)+" "+eval(baseStr+action.x2)+" "+eval(baseStr+action.y2)+" "+eval(baseStr+action.x)+" "+eval(baseStr+action.y)}else{if(action.action=="quadraticCurve"){return path+eval(baseStr+action.x1)+" "+eval(baseStr+action.y1)+" "+eval(baseStr+action.x)+" "+eval(baseStr+action.y)}}return path+eval(baseStr+action.x)+" "+eval(baseStr+action.y)}},linker2svg:function(e,j,o,g){var m=e.points;var k=h(e.from);var l=h(e.to);if(e.attribute&&e.attribute.collapseBy){return}var f=Utils.getEndpointAngle(e,"from");var a=Utils.getEndpointAngle(e,"to");var d=Utils.getLinkerLineStyle(e.lineStyle,g);if(d.lineWidth==0){d.lineWidth=1}if(d.endArrowStyle=="dashedArrow"){l.x=l.x-16}else{if(d.endArrowStyle=="dashedDiamond"){l.x=l.x-18}else{if(d.endArrowStyle=="solidCircle"||d.endArrowStyle=="dashedCircle"){l.x=l.x-10}}}if(d.beginArrowStyle=="dashedArrow"){k.x=k.x+16}else{if(d.beginArrowStyle=="dashedDiamond"){k.x=k.x+16}else{if(d.beginArrowStyle=="dashedCircle"){k.x=k.x+10}}}c();function c(){var s="";var t=j.group();if(e.linkerType=="curve"){s+="M"+k.x+" "+k.y+"C";for(var r=0;r<m.length;r++){var p=h(m[r]);s+=" "+p.x+" "+p.y}s+=" "+l.x+" "+l.y}else{if(e.linkerType=="broken"){s+="M"+k.x+" "+k.y;for(var r=0;r<m.length;r++){var p=h(m[r]);s+="L"+p.x+" "+p.y}s+="L"+l.x+" "+l.y}else{if(e.linkerType=="normal"){s+="M"+k.x+" "+k.y;s+="L"+l.x+" "+l.y}}}var q=t.path(s);var u={width:d.lineWidth,color:"rgb("+d.lineColor+")"};if(d.lineStyle=="dashed"){u=$.extend(u,{dasharray:"8,5"})}else{if(d.lineStyle=="dot"){u=$.extend(u,{dasharray:"3,3"})}else{if(d.lineStyle=="dashdot"){u=$.extend(u,{dasharray:"10,5,3,5"})}}}q.stroke(u);q.fill("none");i(d,q);b(t)}function i(p,r){var q=null;switch(p.beginArrowStyle){case"solidArrow":q=j.marker(16,12,function(t){t.path("M15,1.5 L2,6 L15,10.5").fill("rgb("+p.lineColor+")").stroke({width:p.lineWidth,color:"rgb("+p.lineColor+")"})}).attr("markerUnits","userSpaceOnUse").attr("refX",0);break;case"normal":q=j.marker(16,20,function(t){t.path("M15,1 L1,10 L15,19").fill("none").stroke({width:p.lineWidth,color:"rgb("+p.lineColor+")"})}).attr("markerUnits","userSpaceOnUse").attr("refX",0);break;case"dashedArrow":q=j.marker(16,12,function(t){t.path("M1,6 L15,1 L15,11L1,6").fill("none").stroke({width:p.lineWidth,color:"rgb("+p.lineColor+")"})}).attr("markerUnits","userSpaceOnUse").attr("refX",16);break;case"solidDiamond":q=j.marker(20,12,function(t){t.path("M2,6 L10,2 L18,6 L10,10L2,6").fill("rgb("+p.lineColor+")").stroke({width:p.lineWidth,color:"rgb("+p.lineColor+")"})}).attr("markerUnits","userSpaceOnUse").attr("refX",0);break;case"dashedDiamond":q=j.marker(20,12,function(t){t.path("M2,6 L10,2 L18,6 L10,10L2,6").fill("none").stroke({width:p.lineWidth,color:"rgb("+p.lineColor+")"})}).attr("markerUnits","userSpaceOnUse").attr("refX",16);break;case"solidCircle":q=j.marker(16,16,function(t){t.circle(8).center(8,8).fill("rgb("+p.lineColor+")").stroke({width:p.lineWidth,color:"rgb("+p.lineColor+")"})}).attr("markerUnits","userSpaceOnUse").attr("refX",2);break;case"dashedCircle":q=j.marker(16,16,function(t){t.circle(8).center(8,8).fill("none").stroke({width:p.lineWidth,color:"rgb("+p.lineColor+")"})}).attr("markerUnits","userSpaceOnUse").attr("refX",12);break;case"cross":q=j.marker(14,12,function(t){t.path("M14,0 L0,12").fill("none").stroke({width:p.lineWidth,color:"rgb("+p.lineColor+")"})}).attr("markerUnits","userSpaceOnUse").attr("refX",-1);break;case"asynch1":q=j.marker(20,12,function(t){t.path("M0,8 L15,0").fill("none").stroke({width:p.lineWidth,color:"rgb("+p.lineColor+")"})}).attr("markerUnits","userSpaceOnUse").attr("refX",0).attr("refY",8);break;case"asynch2":q=j.marker(20,12,function(t){t.path("M0,0 L15,8").fill("none").stroke({width:p.lineWidth,color:"rgb("+p.lineColor+")"})}).attr("markerUnits","userSpaceOnUse").attr("refX",0).attr("refY",0);break;default:break}var s=null;switch(p.endArrowStyle){case"solidArrow":s=j.marker(16,12,function(t){t.path("M0,2 L14,6 L0,11 L0,2").fill("rgb("+p.lineColor+")").stroke({width:p.lineWidth,color:"rgb("+p.lineColor+")"})}).attr("markerUnits","userSpaceOnUse").attr("refX",16);break;case"normal":s=j.marker(16,16,function(t){t.path("M0,0 L10,8 L0,16").fill("none").stroke({width:p.lineWidth,color:"rgb("+p.lineColor+")"})}).attr("markerUnits","userSpaceOnUse").attr("refX",11);break;case"dashedArrow":s=j.marker(14,12,function(t){t.path("M1,1 L14,6 L1,11L1,1").fill("none").stroke({width:p.lineWidth,color:"rgb("+p.lineColor+")"})}).attr("markerUnits","userSpaceOnUse").attr("refX",0);break;case"solidDiamond":s=j.marker(20,12,function(t){t.path("M2,6 L10,2 L18,6 L10,10L2,6").fill("rgb("+p.lineColor+")").stroke({width:p.lineWidth,color:"rgb("+p.lineColor+")"})}).attr("markerUnits","userSpaceOnUse").attr("refX",20);break;case"dashedDiamond":s=j.marker(20,12,function(t){t.path("M2,6 L10,2 L18,6 L10,10L2,6").fill("none").stroke({width:p.lineWidth,color:"rgb("+p.lineColor+")"})}).attr("markerUnits","userSpaceOnUse").attr("refX",2);break;case"solidCircle":s=j.marker(16,16,function(t){t.circle(8).center(8,8).fill("rgb("+p.lineColor+")").stroke({width:p.lineWidth,color:"rgb("+p.lineColor+")"})}).attr("markerUnits","userSpaceOnUse").attr("refX",3);break;case"dashedCircle":s=j.marker(16,16,function(t){t.circle(8).center(8,8).fill("none").stroke({width:p.lineWidth,color:"rgb("+p.lineColor+")"})}).attr("markerUnits","userSpaceOnUse").attr("refX",3);break;case"cross":s=j.marker(14,12,function(t){t.path("M14,0 L0,12").fill("none").stroke({width:p.lineWidth,color:"rgb("+p.lineColor+")"})}).attr("markerUnits","userSpaceOnUse").attr("refX",15);break;case"asynch1":s=j.marker(20,12,function(t){t.path("M15,0 L0,8").fill("none").stroke({width:p.lineWidth,color:"rgb("+p.lineColor+")"})}).attr("markerUnits","userSpaceOnUse").attr("refX",16).attr("refY",0);break;case"asynch2":s=j.marker(20,12,function(t){t.path("M15,8 L0,0").fill("none").stroke({width:p.lineWidth,color:"rgb("+p.lineColor+")"})}).attr("markerUnits","userSpaceOnUse").attr("refX",16).attr("refY",8);break;default:break}if(q!=null){r.attr("marker-start","url(#"+q.node.id+")")}if(s!=null){r.attr("marker-end","url(#"+s.node.id+")")}}function b(x){if(e.text==null||e.text==""){return}console.log(e.text);var y=n();var r=Utils.getLinkerFontStyle(e.fontStyle);var t=r.fontFamily;var p="display:none;vertical-align: top;text-align:center;color:rgb(50,50,50);line-height:"+Math.round(r.size*1.25)+"px;font-size:"+r.size+"px;font-family:"+t+";white-space:nowrap;display:inline-block;background:#fff";var w=e.text.replace(/\n/g,"<div></div>");var s=$("<div contenteditable=true style='"+p+";display:inline-block;'></div>").appendTo("body");s.html(w);var u=s.width(),q=s.height();s.remove();var v=x.foreignObject();v.attr("width",u);v.attr("height",q);v.attr("x",y.x-u/2);v.attr("y",y.y-q/2);v.appendChild("div",{innerHTML:w,style:p})}function n(){var x={};if(e.linkerType=="normal"){x={x:0.5*k.x+0.5*l.x,y:0.5*k.y+0.5*l.y}}else{if(e.linkerType=="curve"){var E=k;var C=h(m[0]);var y=h(m[1]);var w=l;x={x:E.x*0.125+C.x*0.375+y.x*0.375+w.x*0.125,y:E.y*0.125+C.y*0.375+y.y*0.375+w.y*0.125}}else{var F=[];F.push(k);for(var r=0;r<m.length;r++){var q=h(m[r]);F.push(q)}F.push(l);var B=0;for(var u=1;u<F.length;u++){var C=F[u-1];var y=F[u];var v=Utils.measureDistance(C,y);B+=v}var A=B/2;var s=0;for(var u=1;u<F.length;u++){var C=F[u-1];var y=F[u];var v=Utils.measureDistance(C,y);var z=s+v;if(z>=A){var D=(A-s)/v;x={x:(1-D)*C.x+D*y.x,y:(1-D)*C.y+D*y.y};break}s=z}}}return x}function h(q){var p=15;return{x:q.x-o.minX-p,y:q.y-o.minY-p}}},calcCanvasSize:function(){var a=null;var g=null;var e=null;var d=null;$(".shape_box").each(function(){var j=$(this);var k=j.position();var i=k.left+j.width();var h=k.top+j.height();if(a==null||k.left<a){a=k.left}if(g==null||k.top<g){g=k.top}if(e==null||i>e){e=i}if(d==null||h>d){d=h}});var b=$("#designer_canvas");if(a==null){a=0;g=0;e=0;d=0}a=a-30;g=g-30;var c=e-a;var f=d-g;return{w:c,h:f,minX:a,minY:g}}};